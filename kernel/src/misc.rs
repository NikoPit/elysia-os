use alloc::boxed::Box;
use conquer_once::spin::OnceCell;
use x86_64::instructions::hlt;

use crate::{
    memory::paging::MAPPER, misc::others::CpuCoreContext,
    multitasking::memory::allocate_kernel_stack,
};

pub mod others;

pub static CPU_CORE_CONTEXT: OnceCell<&mut CpuCoreContext> = OnceCell::uninit();

pub fn init() {
    CPU_CORE_CONTEXT
        .try_get_or_init(|| {
            Box::leak(Box::new(CpuCoreContext {
                gs_kernel_stack_top: allocate_kernel_stack(16, &mut MAPPER.get().unwrap().lock())
                    .as_u64(),
                gs_user_stack_top: 0,
            }))
        })
        .unwrap();
}

pub fn hlt_loop() -> ! {
    loop {
        hlt();
    }
}

#[macro_export]
macro_rules! read_addr {
    ($addr: expr, $type: ty) => {
        *($addr as *mut $type)
    };
}

#[macro_export]
macro_rules! write_addr {
    ($addr: expr, $type: ty, $value: expr) => {
        read_addr!($addr, $type) = $value
    };
}

#[macro_export]
macro_rules! read_port {
    ($port: expr) => {
        Port::new($port).read()
    };
}

#[macro_export]
macro_rules! write_port {
    ($port: expr,$value: expr) => {
        Port::new($port).write($value)
    };
}
